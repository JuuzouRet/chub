<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Karakter Ar≈üivi</title>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --text-sec: #b0b0b0;
            --accent: #ff0266;
            --accent-sec: #03dac6;
            --include-color: #4caf50;
            --exclude-color: #f44336;
            --button-bg: #3700b3;
            --modal-bg: rgba(0, 0, 0, 0.95);
            --border-color: #333;
        }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-color); color: var(--text-main); margin: 0; padding: 20px; }
        .controls { display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; padding: 20px; background-color: var(--card-bg); border-radius: 12px; border: 1px solid var(--border-color); }
        .control-row { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; width: 100%; margin-bottom: 15px; }
        .main-search-input { padding: 12px; border-radius: 6px; border: 1px solid #555; background: #2c2c2c; color: #fff; width: 100%; max-width: 500px; margin-bottom: 10px; }
        .btn { border: none; color: white; padding: 12px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background-color: var(--button-bg); }
        .btn-dice { background-color: var(--accent); }
        .btn-filter { background-color: #444; }
        #status { color: var(--text-sec); font-size: 0.9em; text-align: center; margin-top: 10px; }
        
        /* Grid & Card */
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; min-height: 200px; }
        .card { background-color: var(--card-bg); border-radius: 8px; overflow: hidden; cursor: pointer; border: 1px solid var(--border-color); display: flex; flex-direction: column; }
        .card:hover { transform: translateY(-5px); border-color: var(--accent-sec); }
        .card img { width: 100%; height: 240px; object-fit: cover; background: #000; }
        .card-content { padding: 10px; }
        .card-name { font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-tags { font-size: 0.75em; color: var(--text-sec); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* Filter Panel */
        #filterPanel { display: none; width: 100%; margin-top: 15px; background: #181818; padding: 15px; border-radius: 8px; border: 1px solid #444; }
        .tags-container { display: flex; flex-wrap: wrap; gap: 8px; max-height: 300px; overflow-y: auto; padding: 5px; }
        .filter-tag { background: #333; color: #aaa; border: 1px solid #444; padding: 6px 12px; border-radius: 20px; cursor: pointer; font-size: 0.85em; }
        .filter-tag.include { background: var(--include-color); color: white; }
        .filter-tag.exclude { background: var(--exclude-color); color: white; text-decoration: line-through; }
        .filter-search-bar { width: 100%; padding: 10px; background: #2c2c2c; border: 1px solid #555; color: #fff; margin-bottom: 15px; }
        
        /* Modal */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: var(--modal-bg); align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: var(--card-bg); width: 95%; max-width: 1100px; height: 90vh; border-radius: 12px; display: flex; overflow: hidden; position: relative; border: 1px solid #444; }
        .modal-left { width: 35%; background: #000; display: flex; align-items: center; justify-content: center; }
        .modal-left img { width: 100%; height: 100%; object-fit: contain; }
        .modal-right { width: 65%; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }
        .close-btn { position: absolute; top: 10px; right: 20px; font-size: 40px; color: #fff; cursor: pointer; z-index: 10; }
        h2 { margin-top: 0; color: var(--accent-sec); border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .tag-badge { background: #333; color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; border: 1px solid #555; margin-right: 5px; margin-bottom: 5px; display:inline-block;}
        .field-block { background: #252525; padding: 15px; border-radius: 8px; border-left: 4px solid var(--accent-sec); }
        .field-title { font-weight: bold; color: #fff; margin-bottom: 8px; display: block; text-transform: uppercase; font-size: 0.75em; opacity: 0.8; }
        .field-content { white-space: pre-wrap; font-size: 0.95em; color: #d0d0d0; max-height: 400px; overflow-y: auto; font-family: monospace; }
        
        .pagination { display: none; justify-content: center; align-items: center; gap: 15px; margin-top: 10px; background: #252525; padding: 10px; border-radius: 30px; border: 1px solid var(--accent); }
        .page-info { font-weight: bold; color: var(--accent); }

        @media (max-width: 768px) { .modal-content { flex-direction: column; } .modal-left { width: 100%; height: 300px; } .modal-right { width: 100%; } }
    </style>
</head>
<body>

    <div class="controls">
        <h1>Karakter Ar≈üivi</h1>
        <div class="control-row">
            <label class="btn btn-primary" id="manualUploadBtn" style="display:none;">üìÇ Manuel Y√ºkle<input type="file" id="fileInput" multiple accept=".json"></label>
            <button id="showAllBtn" class="btn btn-primary" disabled>üìã T√ºm Liste</button>
            <button id="toggleFilterBtn" class="btn btn-filter" disabled>‚ö° Filtreler</button>
            <button id="diceBtn" class="btn btn-dice" disabled>üé≤ ZAR AT</button>
        </div>
        <input type="text" id="nameSearch" class="main-search-input" placeholder="üîç Karakter adƒ± ara..." disabled>

        <div id="filterPanel">
            <input type="text" id="tagSearch" class="filter-search-bar" placeholder="Etiket ara...">
            <div id="tagsContainer" class="tags-container"></div>
            <div style="margin-top:10px; display:flex; justify-content:space-between;">
                <button class="btn btn-filter" onclick="clearFilters()">Temizle</button>
                <button class="btn btn-primary" onclick="applyFilters()">Uygula</button>
            </div>
        </div>

        <div id="paginationPanel" class="pagination">
            <button class="btn btn-primary" onclick="changeRandomPage(-1)">‚ùÆ</button>
            <span class="page-info" id="pageIndicator">1</span>
            <button class="btn btn-primary" onclick="changeRandomPage(1)">‚ùØ</button>
        </div>
        <div id="status">Veritabanƒ± par√ßalarƒ± aranƒ±yor...</div>
    </div>

    <div class="grid-container" id="gallery"></div>

    <!-- Modal -->
    <div id="charModal" class="modal"><span class="close-btn" onclick="closeModal()">&times;</span><div class="modal-content"><div class="modal-left"><img id="mImage" src=""></div><div class="modal-right"><h2 id="mName"></h2><div id="mTags"></div><div class="field-block" id="blockDesc"><span class="field-title">Description</span><div class="field-content" id="mDesc"></div></div><div class="field-block" id="blockPersonality"><span class="field-title">Personality</span><div class="field-content" id="mPersonality"></div></div><div class="field-block" id="blockScenario"><span class="field-title">Scenario</span><div class="field-content" id="mScenario"></div></div><div class="field-block" id="blockFirstMes"><span class="field-title">First Message</span><div class="field-content" id="mFirstMes"></div></div><div class="field-block" id="blockSystem"><span class="field-title">System Prompt</span><div class="field-content" id="mSystem"></div></div></div></div></div>

    <script>
        const itemsPerPage = 18;
        const MANUAL_BLOCKLIST = ["NTR", "Gore", "Scat", "Ugly Bastard", "Furry"];
        
        let allCharacters = [], shuffledCharacters = [], currentMode = 'all', randomPageIndex = 0, tagCounts = {};
        let includedTags = new Set(), excludedTags = new Set();
        MANUAL_BLOCKLIST.forEach(t => excludedTags.add(t));

        // Elements
        const els = {
            fileInput: document.getElementById('fileInput'),
            manualBtn: document.getElementById('manualUploadBtn'),
            gallery: document.getElementById('gallery'),
            status: document.getElementById('status'),
            diceBtn: document.getElementById('diceBtn'),
            showAllBtn: document.getElementById('showAllBtn'),
            filterBtn: document.getElementById('toggleFilterBtn'),
            filterPanel: document.getElementById('filterPanel'),
            tagsCont: document.getElementById('tagsContainer'),
            nameSearch: document.getElementById('nameSearch'),
            pagination: document.getElementById('paginationPanel'),
            pageInd: document.getElementById('pageIndicator'),
            tagSearch: document.getElementById('tagSearch')
        };

        // --- PAR√áALI Y√úKLEME Sƒ∞STEMƒ∞ ---
        window.onload = async function() {
            let partIndex = 1;
            let loadedParts = 0;
            let loadedChars = 0;
            let keepLoading = true;
            
            els.status.textContent = "Veritabanƒ± par√ßalarƒ± indiriliyor...";

            while(keepLoading) {
                try {
                    // database_part_1.json, database_part_2.json ... sƒ±rayla dene
                    const response = await fetch(`database_part_${partIndex}.json`);
                    if (!response.ok) {
                        keepLoading = false; // Dosya yoksa dur
                        break;
                    }

                    const jsonPart = await response.json();
                    processDataPart(jsonPart);
                    loadedParts++;
                    loadedChars += jsonPart.length;
                    els.status.textContent = `${loadedParts} par√ßa indirildi (${loadedChars} karakter)...`;
                    partIndex++;
                } catch (e) {
                    keepLoading = false;
                }
            }

            if (loadedParts > 0) {
                finalizeLoading();
            } else {
                els.status.textContent = "Otomatik veritabanƒ± bulunamadƒ±. Manuel y√ºkleme yapƒ±n.";
                els.manualBtn.style.display = "inline-flex";
            }
        };

        function processDataPart(data) {
            let list = Array.isArray(data) ? data : [data];
            list.forEach(c => {
                if(c.topics && Array.isArray(c.topics)) {
                    c.topics.forEach(t => tagCounts[t.trim()] = (tagCounts[t.trim()] || 0) + 1);
                }
                allCharacters.push(c);
            });
        }

        function finalizeLoading() {
            els.diceBtn.disabled = false;
            els.showAllBtn.disabled = false;
            els.filterBtn.disabled = false;
            els.nameSearch.disabled = false;
            els.manualBtn.style.display = "none";
            renderTagButtons();
            applyFilters();
            els.status.textContent = `${allCharacters.length} karakter hazƒ±r!`;
        }

        // --- MANUEL Y√úKLEME ---
        els.fileInput.addEventListener('change', async (e) => {
            if(e.target.files.length === 0) return;
            allCharacters = []; tagCounts = {}; els.gallery.innerHTML = '';
            for(let f of e.target.files) {
                try {
                    const txt = await readFile(f);
                    processDataPart(JSON.parse(txt));
                } catch(err){}
            }
            finalizeLoading();
        });

        // --- FONKSƒ∞YONLAR ---
        els.nameSearch.addEventListener('input', () => {
            if(currentMode === 'random') { currentMode='filtered'; els.pagination.style.display='none'; }
            applyFilters();
        });

        els.showAllBtn.addEventListener('click', () => {
            currentMode = 'all'; els.pagination.style.display = 'none'; applyFilters();
        });

        els.diceBtn.addEventListener('click', () => {
            if(allCharacters.length === 0) return;
            currentMode = 'random'; els.pagination.style.display = 'flex'; els.filterPanel.style.display = 'none';
            const res = getFilteredList();
            if(res.length === 0) { alert("Sonu√ß yok"); return; }
            shuffledCharacters = [...res];
            shuffle(shuffledCharacters);
            randomPageIndex = 0;
            renderRandom();
        });

        function renderRandom() {
            const start = randomPageIndex * itemsPerPage;
            const chunk = shuffledCharacters.slice(start, start + itemsPerPage);
            els.pageInd.textContent = randomPageIndex + 1;
            renderList(chunk);
            els.status.textContent = `Zar Modu: ${itemsPerPage} g√∂steriliyor.`;
            window.scrollTo(0,0);
        }

        window.changeRandomPage = (d) => {
            const max = Math.ceil(shuffledCharacters.length / itemsPerPage);
            const n = randomPageIndex + d;
            if(n >= 0 && n < max) { randomPageIndex = n; renderRandom(); }
        }

        els.filterBtn.addEventListener('click', () => {
            els.filterPanel.style.display = els.filterPanel.style.display === 'block' ? 'none' : 'block';
        });

        function renderTagButtons() {
            els.tagsCont.innerHTML = '';
            Object.keys(tagCounts).sort((a,b) => (tagCounts[b]-tagCounts[a]) || a.localeCompare(b)).forEach(t => {
                const b = document.createElement('div');
                b.className = 'filter-tag';
                b.textContent = `${t} (${tagCounts[t]})`;
                if(excludedTags.has(t)) b.classList.add('exclude');
                b.onclick = () => {
                    if(b.classList.contains('include')) {
                        b.classList.remove('include'); b.classList.add('exclude');
                        includedTags.delete(t); excludedTags.add(t);
                    } else if(b.classList.contains('exclude')) {
                        b.classList.remove('exclude'); excludedTags.delete(t);
                    } else {
                        b.classList.add('include'); includedTags.add(t);
                    }
                };
                els.tagsCont.appendChild(b);
            });
        }

        function getFilteredList() {
            const s = els.nameSearch.value.toLowerCase();
            return allCharacters.filter(c => {
                if(s && !c.name.toLowerCase().includes(s)) return false;
                const ts = c.topics || [];
                for(let x of excludedTags) if(ts.includes(x)) return false;
                for(let i of includedTags) if(!ts.includes(i)) return false;
                return true;
            });
        }

        window.applyFilters = () => {
            if(allCharacters.length === 0) return;
            currentMode = 'filtered'; els.pagination.style.display='none';
            const res = getFilteredList();
            renderList(res);
            els.status.textContent = `Bulunan: ${res.length}`;
        };

        window.clearFilters = () => {
            includedTags.clear(); excludedTags.clear(); els.nameSearch.value="";
            MANUAL_BLOCKLIST.forEach(t => excludedTags.add(t));
            renderTagButtons(); els.status.textContent="Filtreler temizlendi.";
        };

        els.tagSearch.addEventListener('input', (e) => {
            const v = e.target.value.toLowerCase();
            document.querySelectorAll('.filter-tag').forEach(b => b.style.display = b.textContent.toLowerCase().includes(v)?'block':'none');
        });

        function renderList(list) {
            els.gallery.innerHTML = '';
            const frag = document.createDocumentFragment();
            list.forEach(c => {
                const d = document.createElement('div'); d.className='card';
                const img = c.avatar_url || c.max_res_url || (c.definition && c.definition.avatar) || 'https://via.placeholder.com/300x400';
                const tags = (c.topics && Array.isArray(c.topics)) ? c.topics.slice(0,3).join(", ") : "";
                d.innerHTML = `<img src="${img}" loading="lazy"><div class="card-content"><div class="card-name">${c.name}</div><div class="card-tags">${tags}</div></div>`;
                d.onclick = () => openModal(c, img);
                frag.appendChild(d);
            });
            els.gallery.appendChild(frag);
        }

        const modal = document.getElementById('charModal');
        const mElems = { img: document.getElementById('mImage'), name: document.getElementById('mName'), tags: document.getElementById('mTags'), desc: document.getElementById('mDesc'), pers: document.getElementById('mPersonality'), scen: document.getElementById('mScenario'), first: document.getElementById('mFirstMes'), sys: document.getElementById('mSystem') };

        function openModal(d, src) {
            mElems.img.src = src; mElems.name.textContent = d.name; mElems.tags.innerHTML = '';
            if(d.topics) d.topics.forEach(t => {
                const s = document.createElement('span'); s.className='tag-badge'; s.textContent=t; mElems.tags.appendChild(s);
            });
            const def = d.definition || {};
            updField('blockDesc', mElems.desc, d.description || def.description);
            updField('blockPersonality', mElems.pers, def.personality);
            updField('blockScenario', mElems.scen, def.scenario);
            updField('blockFirstMes', mElems.first, def.first_message);
            updField('blockSystem', mElems.sys, def.system_prompt);
            modal.style.display = "flex";
        }
        function updField(id, el, txt) {
            const b = document.getElementById(id);
            if(!txt || txt.trim()==="-" || !txt.trim()) b.style.display='none';
            else { b.style.display='block'; el.textContent=txt; }
        }
        window.closeModal = () => modal.style.display = "none";
        window.onclick = (e) => { if(e.target == modal) closeModal(); };
        function readFile(f) { return new Promise((r, j) => { const rd = new FileReader(); rd.onload=e=>r(e.target.result); rd.onerror=j; rd.readAsText(f); }); }
        function shuffle(a) { for(let i=a.length-1; i>0; i--) { const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }
    </script>
</body>
</html>